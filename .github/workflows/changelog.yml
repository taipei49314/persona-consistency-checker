name: Auto Commit Changelog

on:
  release:
    types: [published]

jobs:
  update-changelog:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout full history
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Pull latest main branch
        run: |
          git fetch origin main
          git checkout main
          git reset --hard origin/main

      - name: Ensure CHANGELOG.md exists
        run: |
          if [ ! -f CHANGELOG.md ]; then
            echo "# ðŸ“¦ Changelog" > CHANGELOG.md
            echo -e "\næœ¬æ–‡ä»¶è¨˜éŒ„ PersonaChain å°ˆæ¡ˆçš„ç™¼ä½ˆæ­·ç¨‹èˆ‡ä¸»è¦è®Šæ›´å…§å®¹ã€‚\n\n---" >> CHANGELOG.md
          fi

      - name: Setup Git Identity
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Extract release type and inject changelog with emoji
        run: |
          RELEASE_TAG="${{ github.event.release.tag_name }}"
          RAW_TITLE="${{ github.event.release.name }}"
          RELEASE_BODY="${{ github.event.release.body }}"

          # é è¨­å€¼
          CATEGORY="[Misc]"
          EMOJI="ðŸ“¦"
          CLEAN_TITLE="$RAW_TITLE"

          # åˆ†é¡žèˆ‡ emoji å°æ‡‰ + æ¸…æ´— title å‰ç¶´
          if echo "$RELEASE_BODY" | grep -qiE '^æ–°å¢žï¼š|^Add:'; then
            CATEGORY="[Add]"
            EMOJI="âœ¨"
            CLEAN_TITLE=$(echo "$RAW_TITLE" | sed -E 's/^(æ–°å¢žï¼š|Add:) ?//I')
          elif echo "$RELEASE_BODY" | grep -qiE '^ä¿®æ­£ï¼š|^Fix:'; then
            CATEGORY="[Fix]"
            EMOJI="ðŸ›"
            CLEAN_TITLE=$(echo "$RAW_TITLE" | sed -E 's/^(ä¿®æ­£ï¼š|Fix:) ?//I')
          elif echo "$RELEASE_BODY" | grep -qiE '^åœç”¨ï¼š|^Deprecate:'; then
            CATEGORY="[Deprecate]"
            EMOJI="âš ï¸"
            CLEAN_TITLE=$(echo "$RAW_TITLE" | sed -E 's/^(åœç”¨ï¼š|Deprecate:) ?//I')
          elif echo "$RELEASE_BODY" | grep -qiE '^ç§»é™¤ï¼š|^Remove:'; then
            CATEGORY="[Remove]"
            EMOJI="ðŸ—‘ï¸"
            CLEAN_TITLE=$(echo "$RAW_TITLE" | sed -E 's/^(ç§»é™¤ï¼š|Remove:) ?//I')
          elif echo "$RELEASE_BODY" | grep -qiE '^å®‰å…¨ï¼š|^Security:'; then
            CATEGORY="[Security]"
            EMOJI="ðŸ”’"
            CLEAN_TITLE=$(echo "$RAW_TITLE" | sed -E 's/^(å®‰å…¨ï¼š|Security:) ?//I')
          elif echo "$RELEASE_BODY" | grep -qiE '^èªªæ˜Žï¼š|^Docs:'; then
            CATEGORY="[Docs]"
            EMOJI="ðŸ“"
            CLEAN_TITLE=$(echo "$RAW_TITLE" | sed -E 's/^(èªªæ˜Žï¼š|Docs:) ?//I')
          fi

          echo -e "\n## [$RELEASE_TAG] - $(date +%F)" >> CHANGELOG.md
          echo "### $EMOJI $CATEGORY $CLEAN_TITLE" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "$RELEASE_BODY" >> CHANGELOG.md
          echo -e "\n---" >> CHANGELOG.md

      - name: Commit and push changes
        run: |
          git add CHANGELOG.md
          git commit -m "Auto-update changelog for ${{ github.event.release.tag_name }}" || echo "No changes"
          git push origin main
